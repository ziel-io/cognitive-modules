{
  "$comment": "Contract validation for behavior_equivalence=false case - confidence must be <= 0.7, meta.risk should reflect uncertainty",
  "$validate": {
    "ok": {
      "const": true
    },
    "meta": {
      "type": "object",
      "required": ["confidence", "risk", "explain"],
      "properties": {
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 0.7
        },
        "risk": {
          "type": "string",
          "enum": ["medium", "high"]
        },
        "explain": {
          "type": "string",
          "minLength": 1,
          "maxLength": 280
        }
      }
    },
    "data": {
      "type": "object",
      "required": ["simplified_code", "changes", "behavior_equivalence", "rationale", "summary"],
      "properties": {
        "simplified_code": {
          "type": "string"
        },
        "behavior_equivalence": {
          "const": false
        },
        "rationale": {
          "type": "string",
          "minLength": 20
        }
      }
    }
  },
  "$example": {
    "ok": true,
    "meta": {
      "confidence": 0.6,
      "risk": "medium",
      "explain": "Condensed caching logic but may have race condition. Behavior equivalence NOT guaranteed."
    },
    "data": {
      "simplified_code": "async function fetchData(url) {\n  return await redis.get(url)\n    ? JSON.parse(await redis.get(url))\n    : await fetch(url).then(r => r.json()).then(d => (redis.set(url, JSON.stringify(d), 'EX', 3600), d));\n}",
      "changes": [
        {
          "type": "simplify_logic",
          "description": "Condensed cache check and fetch into ternary expression",
          "scope": "function",
          "risk": "medium"
        }
      ],
      "behavior_equivalence": false,
      "summary": "Condensed caching logic but may have race condition",
      "rationale": "Cannot guarantee behavior equivalence because: 1) The simplified version makes two redis.get calls which could return different values in a race condition, 2) Async behavior with side effects (redis.set) in ternary is harder to reason about, 3) Error handling differs between original and simplified versions.",
      "extensions": {
        "insights": [
          {
            "text": "Consider using a local variable to cache redis.get result",
            "suggested_mapping": "changes.type.cache_intermediate_value",
            "evidence": "Two await redis.get(url) calls in ternary branches"
          }
        ]
      }
    }
  }
}
